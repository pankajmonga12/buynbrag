angular.module("services.api",[]).factory("api",["$http","$rootScope",function($http,$rootScope){var header={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json; charset=utf-8"},param=function(obj){var name,value,fullSubName,subName,subValue,innerObj,i,query="";for(name in obj)if(value=obj[name],value instanceof Array)for(i=0;i<value.length;++i)subValue=value[i],fullSubName=name+"["+i+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else if(value instanceof Object)for(subName in value)subValue=value[subName],fullSubName=name+"["+subName+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else void 0!==value&&null!==value&&(query+=encodeURIComponent(name)+"="+encodeURIComponent(value)+"&");return query.length?query.substr(0,query.length-1):query};return{get:function(url){return $http({method:"GET",url:"/index.php/"+url,cache:!1}).then(function(response){return response.data})},post:function(u,d){return $http({method:"POST",url:"/index.php/"+u,headers:header,data:param(d)}).then(function(response){return response.data})},productImage:function(sid,pid){return $rootScope.s3baseUrl+sid+"/"+pid+"/"},userImageFb:function(id,dimension){return"https://graph.facebook.com/"+id+"/picture?width="+dimension+"&height="+dimension},userImageBnb:function(gender){return"female"===gender?"/assets/images/default/female.png":"/assets/images/default/male.png"}}}]),angular.module("dmClick",[]).factory("hoverTimestamp",[function(){var timestamp;return{generateTimestamp:function(){timestamp=Date.now()},timestampDiff:function(){return Date.now()-timestamp}}}]).directive("dmClick",["$parse","hoverTimestamp",function($parse,hoverTimestamp){return{restrict:"A",link:function(scope,element,attrs){var startX,startY,startTime,tapElement,tapping=!1,className="hoverActive",fn=attrs.dmClick?$parse(attrs.dmClick):null;if("ontouchstart"in document.documentElement){var hiddenContainer=!1;element.bind("touchstart",function(event){if(element.hasClass("fancyItem")&&element.hasClass(className))return void event.stopPropagation();if(!element.hasClass("fancyItem")){for(var elemRef=element;!elemRef.parent().hasClass("fancyItem");)elemRef=elemRef.parent();hiddenContainer=elemRef.parent()}if(hiddenContainer&&!hiddenContainer.hasClass(className))return void event.preventDefault();tapping=!0,tapElement=event.target?event.target:event.srcElement,startTime=Date.now();var touches=event.touches&&event.touches.length?event.touches:[event],e=touches[0].originalEvent||touches[0];startX=e.clientX,startY=e.clientY}),element.bind("touchmove",function(){tapping=!1}),element.bind("touchend",function(event){var touches=event.changedTouches&&event.changedTouches.length?event.changedTouches:event.touches&&event.touches.length?event.touches:[event],e=touches[0].originalEvent||touches[0],stopX=e.clientX,stopY=e.clientY,stopTime=Date.now(),distValid=stopX-startX>10||stopY-startY>10?!1:!0,timeValid=stopTime-startTime>750?!1:!0;tapping&&distValid&&timeValid&&tapElement&&(element.addClass("hoverActive"),hoverTimestamp.generateTimestamp(),fn&&scope.$apply(function(){fn(scope,{$event:event})})),tapping=!1})}else!fn&&element.hasClass("fancyItem")?(element.bind("mouseenter",function(){!element.hasClass(className)&&element.addClass(className)}),element.bind("mouseleave",function(){element.hasClass(className)&&element.removeClass(className)})):element.bind("click",function(event){fn&&scope.$apply(function(){fn(scope,{$event:event})})})}}}]),angular.module("landingApp",["loginRegisterModule","fancyProducts","followPeople","services.api","dmClick"]).run(["$rootScope",function(){}]).controller("AppController",["$scope","$rootScope","$http","$location","api",function($scope,$rootScope,$http,$location,api){$scope.s3Url="http://buynbragstores.s3.amazonaws.com/assets/images/stores/",$scope.$on("HOMEVIEW",function(){$scope.subview="home",$rootScope.stylesheets=[{href:"/application/views/app/styles/landing.css"}]}),$scope.$on("PEOPLEVIEW",function(){$scope.subview="people"}),$scope.$on("PRODUCTSVIEW",function(){$scope.subview="products",$rootScope.stylesheets=[{href:"/application/views/app/styles/vendor.css"},{href:"/application/views/app/styles/main.css"}]}),$scope.$on("STOREVIEW",function(){$scope.subview="stores"}),api.get("async/checkLogin").then(function(data){var level=data[0]&&data[0].isLoggedIN?data[1][0].rFlowStatus:0;switch($scope.userDetails=data[1][0]||null,+level){case 0:$scope.$broadcast("HOMEVIEW");break;case 1:$scope.$broadcast("PRODUCTSVIEW")}})}]).directive("xhrSpinner",[function(){return{restrict:"A",link:function(scope,element){var temp;scope.$on("showSpinner",function(){element[0].firstElementChild&&(temp=element[0].removeChild(element[0].firstElementChild)),element.addClass("btnActivated")}),scope.$on("hideSpinner",function(){element.removeClass("btnActivated"),element.prepend(temp)})}}}]),angular.module("loginRegisterModule",["services.api"]).directive("ngBlur",[function(){var BLUR_CLASS="ng-blurred";return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){ctrl.$blurred=!1,console.log(scope),element.bind("keydown",function(){element.removeClass(BLUR_CLASS),scope.$apply(function(){ctrl.$blurred=!1,scope.signin_form.submitted=!1,scope.register_form.submitted=!1,scope.resetForm.submitted=!1,scope.wrongPassword=!1,scope.reset.message=""})}),element.bind("blur",function(){element.addClass(BLUR_CLASS),scope.$apply(function(){ctrl.$blurred=!0})})}}}]).directive("loginRegister",[function(){return{restrict:"A",controller:function(){},link:function(){}}}]).directive("user",["$window","$timeout","api","$http","$location","$routeParams","$rootScope",function($window,$timeout,api,$http,$location,$routeParams,$rootScope){function getParameter(paramName){var i,val,searchString=window.location.search.substring(1),params=searchString.split("&");for(i=0;i<params.length;i++)if(val=params[i].split("="),val[0]==paramName)return val[1];return null}function range(a,b,step){var A=[];if("number"==typeof a)for(A[0]=a,step=step||1;b>=a+step;)A[A.length]=a+=step;else{var s="abcdefghijklmnopqrstuvwxyz";a===a.toUpperCase()&&(b=b.toUpperCase(),s=s.toUpperCase()),s=s.substring(s.indexOf(a),s.indexOf(b)+1),A=s.split("")}return A}return{restrict:"A",controller:function(){$rootScope.stylesheets=[{href:"/application/views/app/styles/landing.css"}]},link:function(scope,element){{var userID,email;$location.search()}scope.signin_form.submitted=!1,scope.register_form.submitted=!1,scope.resetForm.submitted=!1,scope.wrongPassword=!1,scope.reset={message:"",success:!1},scope.login={email:""},scope.register={fullName:"",country:"",state:""},email=getParameter("eml"),email?(document.getElementsByClassName("forgotPwd")[0].className+="hide",scope.firstStepClass="active",scope.login.email=email):scope.firstStepClass="";var monitorId,triggerStarted=!1;scope.$watch("login.email",function(val){val&&val.length>0&&!triggerStarted&&(triggerStarted=!0,inputElem=angular.element(element.find("input")[1]),monitorId=window.setInterval(function(){inputElem.triggerHandler("input")},250))}),scope.changeClass=function(cls){scope.firstStepClass=cls},scope.resetPassword=function(){scope.resetForm.$valid?(scope.$broadcast("showSpinner"),api.post("async/forgotPassword/1",{email:scope.reset.email}).then(function(response){scope.$broadcast("hideSpinner"),response.userExists?response.hashGenerated&&(response.hashSaved&&response.emailSent?response.emailSent&&(scope.reset.message="",scope.reset.success=!0):scope.reset.message="Server seems busy, please try after some time"):scope.reset.message="User does not exist"})):scope.resetForm.submitted=!0},scope.signInLocal=function(){triggerStarted&&window.clearInterval(monitorId),scope.signin_form.$valid?(scope.$broadcast("showSpinner"),api.post("async/login",{signin_email:scope.login.email,signin_pw:scope.login.password}).then(function(data){var loginResponse=data[0],userAccount=(data[1],data[2]);loginResponse.sessionSet&&loginResponse.validCredentials&&userAccount.userExists&&1==loginResponse.isActive?$window.location.reload():loginResponse.sessionSet||!userAccount.userExists||loginResponse.validCredentials?(userAccount.newUserCreated||loginResponse.validCredentials&&userAccount.userExists&&0==loginResponse.isActive)&&(scope.$broadcast("hideSpinner"),userID=userAccount.newUserCreated?userAccount.newUserID:loginResponse.ID,scope.showFinalForm=!0,scope.years=range(1930,(new Date).getFullYear()).reverse(),$http.get("/countryList.json").then(function(data){scope.countries=data.data,angular.forEach(scope.countries,function(){scope.register.country=scope.countries[100]})})):(scope.$broadcast("hideSpinner"),scope.wrongPassword=!0)})):scope.signin_form.submitted=!0},scope.registerLocal=function(){scope.register_form.$valid?(scope.$broadcast("showSpinner"),api.post("rapiv1/profile/saveNewUserDetails/"+userID,{fName:scope.register.fullName,dd:scope.register.dobDate,mm:scope.register.dobMonth,yyyy:scope.register.dobYear,sex:scope.register.gender,city:scope.register.state,cc:scope.register.country.code}).then(function(data){var response=data.data;scope.$broadcast("hideSpinner"),response.updateOK&&(console.log("ANALYTICS +++++ log in register vars  "+userID+scope.login.email+scope.register.fullName+scope.register.gender+scope.register.dobDate+scope.register.dobMonth+scope.register.dobYear+scope.register.state+scope.register.country.name),_bnbAnalytics.registerSuccess(userID,scope.login.email,scope.register.fullName,scope.register.gender,scope.register.dobDate,scope.register.dobMonth,scope.register.dobYear,scope.register.state,scope.register.country.name),setTimeout(function(){scope.subview="people"},1e3))})):scope.register_form.submitted=!0}}}}]),angular.module("fancyProducts",[]).directive("fancyProducts",["$rootScope","$window","api",function($rootScope,$window,api){return{restrict:"A",controller:function($scope){$scope.productsFancied=0,stickyElem(document.getElementById("msgBanner"),document.querySelector(".fanciedProductsContainer"),0,56),api.get("rapiv1/ldata/get/0").then(function(data){data.result&&($scope.productsToFancy=data.result)}),$scope.switchView=function(){$scope.productsFancied>=3?$rootScope.$broadcast("PEOPLEVIEW"):alert("Please fancy atleast 3 items!")}},link:function(){}}}]).directive("fancyProduct",["api",function(api){var txtFancy="Fancy It!",txtFancied="Fancied!";return{restrict:"A",scope:{productid:"@"},controller:function($scope){$scope.fancyText=txtFancy},link:function(scope,element){element.bind("mouseup",function(){scope.$apply(function(){scope.fancyText===txtFancy&&api.get("async/fancy2/"+scope.productid).then(function(data){data.fancy&&!data.alreadyFancied&&(scope.fancyText=txtFancied,scope.$parent.$parent.productsFancied++)})})})}}}]),angular.module("followPeople",[]).directive("followPeople",["$rootScope","$window","api",function($rootScope,$window,api){return{restrict:"A",controller:function($scope){$scope.personsFollowed=0,api.get("rapiv1/firstlogin/getHandPickedUsers").then(function(data){var results=data.data||null;results&&(angular.forEach(results,function(value){value.userImgSrc=isNaN(value.userFBID)?api.userImageBnb(value.userGender):api.userImageFb(value.userFBID,75)}),$scope.personsToFollow=results,stickyElem(document.getElementById("msgBanner"),document.querySelector(".fanciedProductsContainer"),0,56))}),$scope.switchView=function(){$scope.personsFollowed>=3?$window.location.reload():alert("Please follow atleast 3 users!")}},link:function(){}}}]).directive("followUser",["api",function(api){var txtFollow="Follow!",txtFollowed="Followed!";return{restrict:"A",scope:{usertofollow:"@",userid:"@"},controller:function($scope){$scope.followText=txtFollow},link:function(scope,element){element.bind("mouseup",function(){scope.$apply(function(){scope.followText===txtFollow&&api.get("rapiv1/profile/follow/"+scope.userid+"/"+scope.usertofollow).then(function(){scope.followText=txtFollowed,scope.$parent.$parent.personsFollowed++})})})}}}]);